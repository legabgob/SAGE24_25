# SAGE 2024 - Prophage analysis
Repository for SAGE course files related to prophage analysis project. Slides can be found at `prophages.pptx`. 

## Disclaimer -  reproducibility

GeNomad and BACPHLIP were installed in micromamba environments, which is the only way we could successfully install them. 

## Introduction

Bacteriophages, viruses targeting bacteria are prevalent in bacteria-rich environments, such as the bee gut microbiota. They play a crucial role in bacterial community regulation, horizontal gene transfer (HGT) either for Auxilliary Metabolic Genes (AMG), virulence factors or antibiotic resistance genes. Altogether, this makes bacteriophages quite interesting to study, especially given the lack of data available. It is also important to know that they mostly follow two different life cycles :

- Strictly lytic phages inject their genome into the bacteria, hijack the replication systems of the host bacteria to multiply, and then exit the bacteria via lysis, killing the bacteria.
- Lysogenic phages inject their genome in the bacteria, but can integrate the bacterial genome and stay in a dormant stage, when it is then referred to as a prophage. It can later exit the bacteria and enter a lytic cycle.

## Prophage detection - PHASTEST

The first software we attempted to use is called [PHASTEST](https://phastest.ca/), which is reputed to be more precise than GeNomad for prophage detection. While a Docker version of the software is available, installing it locally proved challenging. After numerous attempts, we successfully installed it on our local machine. However, due to the significant computational power required, running the entire prophage detection process locally was impractical within our time constraints.

As a result, we decided to install the software on the cluster to make the process feasible. Unfortunately Curnagl is not particularly user-friendly for installing applications without explicit administrator approval. While it is possible to run containerized applications on the cluster using [Singularity](https://github.com/apptainer/singularity), we faced numerous obstacles trying to bypass the cluster's restrictions to install PHASTEST.

Ultimately, after exhausting our options, we decided to proceed with prophage detection using GeNomad instead. This compromise allowed us to move forward with our analysis without further delays.

## Prophage detection - GeNomad

GeNomad was installed and ran using the `genomad_mamba_step1.sh` script. It gave as output a taxonomy estimation (`combined_provirus_taxonomy.tsv`), genomes of detected prophages and an annotation for genes detected in these prophage sequences. 

## Gene functional annotation

This step of the analysis also utilized the initial annotation generated by the GeNomad software. GeNomad produces a file called `genes.bed`, which contains the predicted genes identified during its analysis. I adapted the format of this file slightly to facilitate its analysis in R.

To streamline the process, I created a script named `gene_functional_analysis.R`, which contains the necessary code to fetch the functional annotations of the predicted genes using the  [KEGG](https://www.genome.jp/kegg/) database API. This script also generates a bar chart visualizing the various functional groups within our community, providing an overview of their distribution.

Upon completing this analysis, we realized that the majority of the predicted genes had no known function. While this outcome is partially expected in phages due to their unique biology, it became clear that this level of annotation would be insufficient for conducting any meaningful functional analysis.

To address this limitation, we proposed during the presentation that if this project were to be pursued in a real-world context, one of the next steps should involve extending the functional annotation of these genes using AlphaFold3. This approach could provide deeper insights into the structural and functional properties of the unidentified genes, enabling more comprehensive downstream analyses.

## Prophage classification - TaxMyPhage (failed)

TaxmyPhage was installed with the `run_taxmyphage.sh` script and worked. It gave us as an output, the taxonomy of our strains. But, no hits were found with our genomes. We tested where the issue came from and we found that the issue likely comes from the absence of our phages genomes in the databases used by TaxmyPhage. You can find the output of the taxonomy table in the `Summary_taxonomy.tsv`.

## Lifecycle classification - BACPHLIP

BACPHLIP was installed in a micromamba environment and ran using the `bacphlip.sh` script. As input, it needed all the prophage genome sequences in fasta format, which were obtained from the genomad output and regrouped in a single file (`mega_fasta.fasta`). It then returned as output a combined dataframe containing the probabilities of a phage either being lytic (virulent) or lysogenic (temperate). The result file can be found at `mega_fasta.fasta.bacphlip`. 

## Similarity between phages - [VIRIDIC Web](https://rhea.icbm.uni-oldenburg.de/viridic/)

We used VIRIDIC WEB version to have the output and kept the initial parameters to run the analysis. VIRIDIC (Virus Intergenomic Distance Calculator) computes pairwise intergenomic distances/similarities amongst viral genomes. You can find all the output in the `VIRIDIC.zip` file.

## Proteomic study - [VIPTree Web](https://www.genome.jp/viptree/upload)

We used VIPTree WEB version to have the output and kept the initial parameters to run the analysis.
VIPTree generates a proteomic tree of viral genome sequences based on genome-wide sequence similarities computed by tBLASTx. It also offers an excellent alignment visualization useful for comparative genomics of viruses. In addition, it can do gene annotation and find protein similarities. You can find the output in the `VIPTree.zip` file. 


## Prevalence analysis

The output file coming from BACPHLIP was then combined with the metadata table in R, this to associate each prophage and its classification to the host sample and its metadata. Sadly, we lost the code used to make this combined dataframe, but itself can be found in `prevalence_final.csv`. 

## PyAni

We tried to use PyAni to get Average Nucleotide Identity (ANI) comparisons between whole genomes to try and get an idea of the genomic similarities between phages, but we failed to make it work. We tried the `anim` (using MUMMER) and `anib` (using BLAST+) methods. The former reported that we failed to compute at least one pairwise comparison and stopped running, and the latter was strangely no longer implemented in the version of PyAni we tried to use. The script used to try and run this analysis can be found at `run_pyani.sh`.


## R analysis

We used R to format the data from the GENOMAD output to a big fasta file with all the phages sequences in it to be able to use as input for other software.
Then with the Output of VIRIDIC we created a similarity heatmap between the phages that we had.
Based on the similarity matrix from VIRIDIC we also used multidimensional scaling to get euclidean coordinate to perform kmeans clustering. we used the elbow method to choose the number of cluster. After plotting the results of the kmeans clustering in 2d we labelled the points with metadata such as host tribe and host species to search for clusters. We also plotted it in 3d to better assess some unclustered region of phages.
The R script used to do that can be found under the folder "R_scripts" with the name `prophages_analysis.rmd`.

## Figures

The figures for the presentation were vectorized using the free and open-source software [Inkscape](https://inkscape.org/).
